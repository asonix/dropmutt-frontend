<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Dropmutt</title>
        <style>
html, head, body {
    padding:0;
    margin:0;
}

body {
    font-family: calibri, helvetica, arial, sans-serif;
}
        </style>
    </head>
    <body>
        <script type="text/javascript" src="/_compile/src/Main.elm"></script>
        <script type="text/javascript">
var app = Elm.Main.fullscreen();
var preparedFiles = null;

function FileUpload(files) {
    this.xhr = new XMLHttpRequest();
    this.xhr.withCredentials = true;
    var self = this;

    this.uploadFiles = function (ev) {
        self.xhr.open("POST", ev);

        var formData = new FormData();
        for (var i = 0; i < files.length; i++) {
            formData.append("file-uploads[]", files[i], files[i].name);
        }

        self.xhr.send(formData);
    };

    this.xhr.upload.addEventListener("progress", function (ev) {
        if (ev.lengthComputable) {
            var percentage = Math.round((ev.loaded * 100) / ev.total);

            if (percentage === 100) {
                app.ports.uploadProcessing.send(0);
            } else {
                app.ports.uploadPercentage.send(percentage);
            }
        }
    }, false);

    this.xhr.upload.addEventListener("load", function (ev) {
        app.ports.uploadProcessing.send(0);
    }, false);

    this.xhr.onreadystatechange = function () {
        if (self.xhr.readyState == 4) {
            if (self.xhr.status == 201) {
                app.ports.uploadSucceeded.send(0);
            } else {
                app.ports.uploadFailed.send(0);
            }
            preparedFiles = null;
        }
    };
}

app.ports.imagesSelected.subscribe(function (id) {
    var node = document.getElementById(id);
    if (node === null) {
        app.ports.uploadFailed.send(0);
        return;
    }

    preparedFiles = new FileUpload(node.files);
});

app.ports.performUpload.subscribe(function (uploadurl) {
    if (preparedFiles === null) {
        app.ports.uploadFailed.send(0);
        return;
    }

    preparedFiles.uploadFiles(uploadurl);
});
        </script>
    </body>
</html>
