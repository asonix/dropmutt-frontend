<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Dropmutt</title>
        <style>
html, head, body {
    padding:0;
    margin:0;
}

body {
    font-family: calibri, helvetica, arial, sans-serif;
}
        </style>
    </head>
    <body>
        <script type="text/javascript" src="/_compile/src/Main.elm"></script>
        <script type="text/javascript">
var app = Elm.Main.fullscreen();

function FileUpload(formNode, uploadUrl) {
    this.xhr = new XMLHttpRequest();
    this.xhr.withCredentials = true;
    var self = this;

    this.uploadFiles = function () {
        self.xhr.open("POST", uploadUrl);

        var formData = new FormData(formNode);

        self.xhr.send(formData);
    };

    this.xhr.upload.addEventListener("progress", function (ev) {
        if (ev.lengthComputable) {
            var percentage = Math.round((ev.loaded * 100) / ev.total);

            if (percentage === 100) {
                app.ports.uploadProcessing.send(0);
            } else {
                app.ports.uploadPercentage.send(percentage);
            }
        }
    }, false);

    this.xhr.upload.addEventListener("load", function (ev) {
        app.ports.uploadProcessing.send(0);
    }, false);

    this.xhr.onreadystatechange = function () {
        if (self.xhr.readyState == 4) {
            if (self.xhr.status == 201) {
                app.ports.uploadSucceeded.send(0);
            } else {
                app.ports.uploadFailed.send(0);
            }
            preparedFiles = null;
        }
    };
}

app.ports.performUpload.subscribe(function (input) {
    var formId = input[0];
    var uploadUrl = input[1];
    var formNode = document.getElementById(formId);

    if (formNode === null || uploadUrl === null) {
        app.ports.uploadFailed.send(0);
        return;
    }

    var f = new FileUpload(formNode, uploadUrl);
    f.uploadFiles();
});
        </script>
    </body>
</html>
